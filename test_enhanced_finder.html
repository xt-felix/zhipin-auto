<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>增强版元素查找函数测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
        }
        .test-container {
            border: 1px solid #ccc;
            padding: 20px;
            margin-bottom: 20px;
        }
        .resume-basic-new__meta-item {
            background-color: #f5f5f5;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .hidden {
            display: none;
        }
        button {
            padding: 10px 15px;
            margin: 5px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
        #results {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <h1>增强版元素查找函数测试</h1>
    
    <div class="test-container">
        <h2>测试元素</h2>
        <div class="resume-basic-new__meta-item">候选人信息 1</div>
        <div class="resume-basic-new__meta-item">候选人信息 2</div>
        <div class="resume-basic-new__meta-item hidden">隐藏的候选人信息</div>
        <div id="resume-basic-new__meta-item">ID选择器元素</div>
        <p class="resume-basic-new__meta-item">段落形式的候选人信息</p>
    </div>
    
    <div class="test-container">
        <h2>测试控件</h2>
        <button onclick="testFindElements()">测试元素查找</button>
        <button onclick="toggleHiddenElement()">切换隐藏元素</button>
        <button onclick="addNewElement()">动态添加新元素</button>
        <button onclick="clearResults()">清空结果</button>
    </div>
    
    <div id="results">
        <h2>测试结果</h2>
        <pre id="output"></pre>
    </div>

    <script>
        // 辅助函数：检查元素是否可见
        function isElementVisible(element) {
            if (!element) return false;
            
            // 检查元素本身是否可见
            const style = window.getComputedStyle(element);
            if (style.display === 'none' || style.visibility === 'hidden' || style.opacity === '0') {
                return false;
            }
            
            // 检查元素是否在视口内
            const rect = element.getBoundingClientRect();
            if (rect.width === 0 || rect.height === 0) {
                return false;
            }
            
            return true;
        }

        // 辅助函数：等待元素出现
        function waitForElements(selector, options = {}) {
            const { timeout = 3000, interval = 100 } = options;
            return new Promise((resolve) => {
                const startTime = Date.now();
                
                const check = () => {
                    const elements = document.querySelectorAll(selector);
                    const visibleElements = Array.from(elements).filter(el => isElementVisible(el));
                    
                    if (visibleElements.length > 0) {
                        resolve({ elements: visibleElements, method: 'waitForElements' });
                    } else if (Date.now() - startTime > timeout) {
                        resolve({ elements: [], method: 'waitForElements', message: '超时未找到元素' });
                    } else {
                        setTimeout(check, interval);
                    }
                };
                
                check();
            });
        }

        // 通用元素查找函数 - 增强版本
        function findElementsByMultipleMethods(selector, options = {}) {
            const {
                timeout = 0,  // 默认不等待
                includeHidden = false,  // 是否包含隐藏元素
                methods = ['all']  // 要使用的查找方法
            } = options;
            
            // 如果设置了超时，则使用等待模式
            if (timeout > 0) {
                return waitForElements(selector, { timeout, interval: 100 });
            }
            
            // 方法1: querySelectorAll
            if (methods.includes('all') || methods.includes('querySelectorAll')) {
                try {
                    const elements = document.querySelectorAll(selector);
                    let filteredElements = Array.from(elements);
                    
                    // 过滤隐藏元素（如果需要）
                    if (!includeHidden) {
                        filteredElements = filteredElements.filter(el => isElementVisible(el));
                    }
                    
                    if (filteredElements.length > 0) {
                        console.log(`方法1 (querySelectorAll) 找到 ${filteredElements.length} 个元素`);
                        return { elements: filteredElements, method: 'querySelectorAll' };
                    }
                } catch (e) {
                    console.log(`方法1 (querySelectorAll) 查询失败:`, e);
                }
            }
            
            // 方法2: getElementsByClassName (如果是类选择器)
            if ((methods.includes('all') || methods.includes('getElementsByClassName')) && selector.startsWith('.')) {
                try {
                    const className = selector.substring(1);
                    const elements = document.getElementsByClassName(className);
                    let filteredElements = Array.from(elements);
                    
                    // 过滤隐藏元素（如果需要）
                    if (!includeHidden) {
                        filteredElements = filteredElements.filter(el => isElementVisible(el));
                    }
                    
                    if (filteredElements.length > 0) {
                        console.log(`方法2 (getElementsByClassName) 找到 ${filteredElements.length} 个元素`);
                        return { elements: filteredElements, method: 'getElementsByClassName' };
                    }
                } catch (e) {
                    console.log(`方法2 (getElementsByClassName) 查询失败:`, e);
                }
            }
            
            // 方法3: getElementsByTagName (如果是标签选择器)
            if ((methods.includes('all') || methods.includes('getElementsByTagName')) && /^[a-zA-Z]/.test(selector)) {
                try {
                    const elements = document.getElementsByTagName(selector);
                    let filteredElements = Array.from(elements);
                    
                    // 过滤隐藏元素（如果需要）
                    if (!includeHidden) {
                        filteredElements = filteredElements.filter(el => isElementVisible(el));
                    }
                    
                    if (filteredElements.length > 0) {
                        console.log(`方法3 (getElementsByTagName) 找到 ${filteredElements.length} 个元素`);
                        return { elements: filteredElements, method: 'getElementsByTagName' };
                    }
                } catch (e) {
                    console.log(`方法3 (getElementsByTagName) 查询失败:`, e);
                }
            }
            
            // 方法4: XPath查找
            if (methods.includes('all') || methods.includes('xpath')) {
                try {
                    // 将CSS选择器转换为简单XPath
                    let xpath = '';
                    if (selector.startsWith('.')) {
                        // 类选择器
                        const className = selector.substring(1);
                        xpath = `//*[contains(@class, '${className}')]`;
                    } else if (selector.startsWith('#')) {
                        // ID选择器
                        const id = selector.substring(1);
                        xpath = `//*[@id='${id}']`;
                    } else if (/^[a-zA-Z]/.test(selector)) {
                        // 标签选择器
                        xpath = `//${selector}`;
                    }
                    
                    if (xpath) {
                        const result = document.evaluate(xpath, document, null, XPathResult.ORDERED_NODE_SNAPSHOT_TYPE, null);
                        const elements = [];
                        for (let i = 0; i < result.snapshotLength; i++) {
                            elements.push(result.snapshotItem(i));
                        }
                        
                        let filteredElements = elements;
                        
                        // 过滤隐藏元素（如果需要）
                        if (!includeHidden) {
                            filteredElements = filteredElements.filter(el => isElementVisible(el));
                        }
                        
                        if (filteredElements.length > 0) {
                            console.log(`方法4 (XPath) 找到 ${filteredElements.length} 个元素`);
                            return { elements: filteredElements, method: 'xpath' };
                        }
                    }
                } catch (e) {
                    console.log(`方法4 (XPath) 查询失败:`, e);
                }
            }
            
            // 方法5: 通过文本内容查找
            if (methods.includes('all') || methods.includes('textSearch')) {
                try {
                    // 提取选择器中的文本关键词（如果有的话）
                    const keywords = selector.match(/[^\s.#\[\]]+/g) || [];
                    if (keywords.length > 0) {
                        const allElements = Array.from(document.body.getElementsByTagName('*'));
                        const elements = allElements.filter(el => {
                            const text = el.textContent || el.innerText || '';
                            return keywords.some(keyword => text.includes(keyword));
                        });
                        
                        let filteredElements = elements;
                        
                        // 过滤隐藏元素（如果需要）
                        if (!includeHidden) {
                            filteredElements = filteredElements.filter(el => isElementVisible(el));
                        }
                        
                        if (filteredElements.length > 0) {
                            console.log(`方法5 (文本搜索) 找到 ${filteredElements.length} 个元素`);
                            return { elements: filteredElements, method: 'textSearch' };
                        }
                    }
                } catch (e) {
                    console.log(`方法5 (文本搜索) 查询失败:`, e);
                }
            }
            
            // 方法6: DOM遍历查找
            if (methods.includes('all') || methods.includes('domTraversal')) {
                try {
                    const elements = [];
                    const walk = document.createTreeWalker(
                        document.body,
                        NodeFilter.SHOW_ELEMENT,
                        {
                            acceptNode: function(node) {
                                // 检查节点是否匹配选择器
                                try {
                                    if (node.matches && node.matches(selector)) {
                                        return NodeFilter.FILTER_ACCEPT;
                                    }
                                } catch (e) {
                                    // 忽略不支持的选择器
                                }
                                return NodeFilter.FILTER_SKIP;
                            }
                        }
                    );
                    
                    let node;
                    while (node = walk.nextNode()) {
                        elements.push(node);
                    }
                    
                    let filteredElements = elements;
                    
                    // 过滤隐藏元素（如果需要）
                    if (!includeHidden) {
                        filteredElements = filteredElements.filter(el => isElementVisible(el));
                    }
                    
                    if (filteredElements.length > 0) {
                        console.log(`方法6 (DOM遍历) 找到 ${filteredElements.length} 个元素`);
                        return { elements: filteredElements, method: 'domTraversal' };
                    }
                } catch (e) {
                    console.log(`方法6 (DOM遍历) 查询失败:`, e);
                }
            }
            
            console.log(`未能找到目标元素`);
            return { elements: [], method: 'none', message: '未找到元素' };
        }

        // 测试函数
        function testFindElements() {
            const output = document.getElementById('output');
            output.textContent += '开始测试元素查找...\\n';
            
            // 测试1: 基本查找
            output.textContent += '\\n--- 测试1: 基本查找 ---\\n';
            const result1 = findElementsByMultipleMethods('.resume-basic-new__meta-item');
            output.textContent += `查找结果: ${result1.elements.length} 个元素 (使用方法: ${result1.method})\\n`;
            
            // 测试2: 包含隐藏元素
            output.textContent += '\\n--- 测试2: 包含隐藏元素 ---\\n';
            const result2 = findElementsByMultipleMethods('.resume-basic-new__meta-item', { includeHidden: true });
            output.textContent += `查找结果: ${result2.elements.length} 个元素 (使用方法: ${result2.method})\\n`;
            
            // 测试3: 特定方法查找
            output.textContent += '\\n--- 测试3: 仅使用querySelectorAll方法 ---\\n';
            const result3 = findElementsByMultipleMethods('.resume-basic-new__meta-item', { methods: ['querySelectorAll'] });
            output.textContent += `查找结果: ${result3.elements.length} 个元素 (使用方法: ${result3.method})\\n`;
            
            // 测试4: ID选择器
            output.textContent += '\\n--- 测试4: ID选择器查找 ---\\n';
            const result4 = findElementsByMultipleMethods('#resume-basic-new__meta-item');
            output.textContent += `查找结果: ${result4.elements.length} 个元素 (使用方法: ${result4.method})\\n';
            
            // 测试5: 标签选择器
            output.textContent += '\\n--- 测试5: 标签选择器查找 ---\\n';
            const result5 = findElementsByMultipleMethods('p');
            output.textContent += `查找结果: ${result5.elements.length} 个元素 (使用方法: ${result5.method})\\n';
            
            // 测试6: XPath查找
            output.textContent += '\\n--- 测试6: XPath查找 ---\\n';
            const result6 = findElementsByMultipleMethods('.resume-basic-new__meta-item', { methods: ['xpath'] });
            output.textContent += `查找结果: ${result6.elements.length} 个元素 (使用方法: ${result6.method})\\n';
            
            // 测试7: 等待模式
            output.textContent += '\\n--- 测试7: 等待模式查找 ---\\n';
            output.textContent += '等待模式测试 (3秒超时):\\n';
            findElementsByMultipleMethods('.future-element', { timeout: 3000 })
                .then(result => {
                    output.textContent += `等待模式结果: ${result.elements.length} 个元素 (使用方法: ${result.method})\\n`;
                });
        }

        // 切换隐藏元素显示
        function toggleHiddenElement() {
            const hiddenElement = document.querySelector('.resume-basic-new__meta-item.hidden');
            if (hiddenElement) {
                hiddenElement.classList.toggle('hidden');
                const action = hiddenElement.classList.contains('hidden') ? '隐藏' : '显示';
                document.getElementById('output').textContent += `\\n已${action}隐藏元素\\n`;
            }
        }

        // 动态添加新元素
        function addNewElement() {
            const container = document.querySelector('.test-container');
            const newElement = document.createElement('div');
            newElement.className = 'resume-basic-new__meta-item';
            newElement.textContent = '动态添加的候选人信息';
            container.appendChild(newElement);
            document.getElementById('output').textContent += '\\n已添加新元素\\n';
        }

        // 清空结果
        function clearResults() {
            document.getElementById('output').textContent = '';
        }
    </script>
</body>
</html>